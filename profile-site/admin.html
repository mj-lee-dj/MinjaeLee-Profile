<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ê´€ë¦¬ì â€” ì´ë¯¼ì¬ í¬íŠ¸í´ë¦¬ì˜¤</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  <style>
    :root {
      --bg: #0e0e10;
      --card: #1a1a1e;
      --card2: #222228;
      --border: #2e2e34;
      --red: #e50914;
      --blue: #3b82f6;
      --green: #22c55e;
      --text: #f5f5f5;
      --text2: #9ca3af;
      --font: 'Pretendard', 'Noto Sans KR', 'Inter', sans-serif;
      --radius: 10px
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh
    }

    a {
      color: inherit;
      text-decoration: none
    }

    .layout {
      display: flex;
      min-height: 100vh
    }

    .sidebar {
      width: 240px;
      background: var(--card);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: fixed;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 10
    }

    .sidebar-logo {
      font-size: 1.1rem;
      font-weight: 800;
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px
    }

    .sidebar-logo span {
      color: var(--red)
    }

    .sidebar-nav {
      list-style: none
    }

    .sidebar-nav a,
    .sidebar-nav button {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 24px;
      font-size: .9rem;
      font-weight: 600;
      color: var(--text2);
      transition: all .2s;
      cursor: pointer;
      border: none;
      background: none;
      text-align: left;
      font-family: inherit
    }

    .sidebar-nav a:hover,
    .sidebar-nav button:hover {
      background: rgba(255, 255, 255, .04);
      color: #fff
    }

    .sidebar-nav a.active,
    .sidebar-nav button.active {
      color: #fff;
      background: rgba(229, 9, 20, .12);
      border-right: 3px solid var(--red)
    }

    .main {
      margin-left: 240px;
      flex: 1;
      padding: 32px 40px;
      max-width: 1100px
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 12px
    }

    .page-title {
      font-size: 1.6rem;
      font-weight: 800
    }

    .page-title small {
      font-size: .85rem;
      font-weight: 500;
      color: var(--text2);
      margin-left: 8px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: .88rem;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all .2s;
      font-family: inherit
    }

    .btn-red {
      background: var(--red);
      color: #fff
    }

    .btn-red:hover {
      background: #b20710
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text2)
    }

    .btn-outline:hover {
      border-color: #555;
      color: #fff
    }

    .btn-green {
      background: var(--green);
      color: #fff
    }

    .btn-green:hover {
      background: #16a34a
    }

    .btn-blue {
      background: var(--blue);
      color: #fff
    }

    .btn-blue:hover {
      background: #2563eb
    }

    .btn-sm {
      padding: 7px 14px;
      font-size: .8rem
    }

    .btn-danger {
      background: transparent;
      border: 1px solid #ef4444;
      color: #ef4444
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, .12)
    }

    .data-table {
      width: 100%;
      border-collapse: collapse
    }

    .data-table th {
      font-size: .75rem;
      font-weight: 700;
      color: var(--text2);
      text-align: left;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      letter-spacing: .06em;
      text-transform: uppercase
    }

    .data-table td {
      font-size: .88rem;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, .04);
      vertical-align: top
    }

    .data-table tr:hover td {
      background: rgba(255, 255, 255, .02)
    }

    .data-table .actions {
      display: flex;
      gap: 6px;
      white-space: nowrap
    }

    .hl-badge {
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(229, 9, 20, .15);
      color: var(--red);
      font-weight: 700
    }

    .link-badge {
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(59, 130, 246, .15);
      color: var(--blue);
      font-weight: 700
    }

    .img-badge {
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(34, 197, 94, .15);
      color: var(--green);
      font-weight: 700
    }

    .td-thumb {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid var(--border)
    }

    /* ëª¨ë‹¬ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      z-index: 100;
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: 40px 20px;
      overflow-y: auto;
      backdrop-filter: blur(4px)
    }

    .modal-overlay.open {
      display: flex
    }

    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 640px;
      max-width: 100%;
      padding: 32px
    }

    .modal h3 {
      font-size: 1.2rem;
      font-weight: 800;
      margin-bottom: 20px
    }

    .form-row {
      margin-bottom: 16px
    }

    .form-label {
      font-size: .8rem;
      font-weight: 700;
      color: var(--text2);
      margin-bottom: 6px;
      display: block
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card2);
      color: var(--text);
      font-size: .9rem;
      font-family: inherit;
      outline: none;
      transition: border .2s
    }

    .form-input:focus,
    .form-textarea:focus {
      border-color: var(--red)
    }

    .form-textarea {
      height: 80px;
      resize: vertical
    }

    .form-check {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: .9rem
    }

    .form-check input {
      accent-color: var(--red);
      width: 18px;
      height: 18px
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border)
    }

    .form-hint {
      font-size: .75rem;
      color: var(--text2);
      margin-top: 4px
    }

    /* ë§í¬ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
    .link-preview-area {
      margin-top: 8px;
      padding: 16px;
      border-radius: var(--radius);
      background: var(--card2);
      border: 1px solid var(--border)
    }

    .link-row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .link-row .form-input {
      flex: 1
    }

    .fetch-btn {
      white-space: nowrap
    }

    .preview-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, .03);
      border: 1px solid var(--border)
    }

    .preview-result img {
      max-height: 120px;
      border-radius: 6px;
      margin-top: 8px;
      border: 1px solid var(--border)
    }

    .preview-desc {
      font-size: .85rem;
      color: var(--text2);
      margin-top: 8px;
      line-height: 1.5
    }

    .fetching {
      color: var(--blue);
      font-size: .85rem;
      animation: pulse 1.2s ease infinite
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .4
      }
    }

    /* ì´ë¯¸ì§€ ëª©ë¡ */
    .img-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px
    }

    .img-list-item {
      position: relative;
      width: 100px;
      height: 70px;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border)
    }

    .img-list-item img {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .img-list-item .remove-img {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(0, 0, 0, .7);
      color: #fff;
      border: none;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center
    }

    /* í†µê³„ ì¹´ë“œ */
    .stat-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 36px
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center
    }

    .sc-val {
      font-size: 2rem;
      font-weight: 800;
      color: var(--red)
    }

    .sc-label {
      font-size: .82rem;
      color: var(--text2);
      margin-top: 4px
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      border-radius: 10px;
      background: var(--green);
      color: #fff;
      font-weight: 700;
      font-size: .9rem;
      z-index: 200;
      transform: translateY(80px);
      opacity: 0;
      transition: all .35s ease
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1
    }

    .preview-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--blue);
      font-size: .85rem;
      font-weight: 600;
      margin-top: 8px
    }

    .preview-link:hover {
      text-decoration: underline
    }

    /* ìë™ ë“±ë¡ */
    .auto-zone {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px
    }

    .auto-zone h4 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 16px
    }

    .drop-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 40px;
      text-align: center;
      color: var(--text2);
      cursor: pointer;
      transition: all .2s;
      margin-bottom: 16px
    }

    .drop-area:hover,
    .drop-area.dragover {
      border-color: var(--red);
      background: rgba(229, 9, 20, .04);
      color: #fff
    }

    .drop-area input[type=file] {
      display: none
    }

    .ai-status {
      padding: 16px;
      border-radius: var(--radius);
      background: var(--card2);
      border: 1px solid var(--border);
      margin-top: 12px;
      font-size: .9rem;
      line-height: 1.7
    }

    .ai-result-card {
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-top: 16px
    }

    .ai-result-card h4 {
      color: var(--red);
      margin-bottom: 12px
    }

    .ai-field {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      font-size: .88rem
    }

    .ai-field .label {
      font-weight: 700;
      color: var(--text2);
      min-width: 80px;
      flex-shrink: 0
    }

    .ai-field .value {
      flex: 1
    }

    .ai-img-preview {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0
    }

    .ai-img-preview img {
      height: 80px;
      border-radius: 6px;
      border: 1px solid var(--border)
    }

    .api-key-area {
      margin-bottom: 24px;
      padding: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius)
    }

    .api-key-area .form-input {
      max-width: 480px
    }

    @media(max-width:768px) {
      .sidebar {
        width: 100%;
        position: static;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding: 16px
      }

      .sidebar-nav {
        display: flex;
        overflow-x: auto;
        gap: 4px
      }

      .sidebar-nav a,
      .sidebar-nav button {
        white-space: nowrap;
        padding: 8px 16px;
        border-right: none !important
      }

      .main {
        margin-left: 0;
        padding: 20px
      }

      .stat-cards {
        grid-template-columns: repeat(2, 1fr)
      }

      .layout {
        flex-direction: column
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      20%,
      60% {
        transform: translateX(-5px);
      }

      40%,
      80% {
        transform: translateX(5px);
      }
    }

    .shake {
      animation: shake 0.4s ease-in-out;
      border-color: #ef4444 !important;
    }

    /* ë“œë˜ê·¸ì•¤ë“œë¡­ ìŠ¤íƒ€ì¼ */
    .drag-handle {
      cursor: grab;
      font-size: 1.1rem;
      color: var(--text2);
      user-select: none;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all .2s;
    }

    .drag-handle:hover {
      color: var(--red);
      background: rgba(229, 9, 20, .1);
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    tr.dragging {
      opacity: .4;
      background: var(--card2) !important;
    }

    tr.drag-over {
      border-top: 2px solid var(--red) !important;
    }

    tr.drag-over-below {
      border-bottom: 2px solid var(--red) !important;
    }

    /* ì´ë¯¸ì§€ ë“œë˜ê·¸ì•¤ë“œë¡­ */
    .img-list-item.img-dragging {
      opacity: .35;
      transform: scale(.9);
    }

    .img-list-item.img-drag-over {
      outline: 2px solid var(--blue);
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-logo">ê´€ë¦¬ì<span>.</span></div>
      <ul class="sidebar-nav" id="sideNav">
        <li><button class="active" data-tab="dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button></li>
        <li><button data-tab="autoRegister" style="color:var(--red);font-weight:800">ğŸ¤– ìë™ ë“±ë¡</button></li>
        <li><button data-tab="lectures">ğŸ¤ ê°•ì˜ì´ë ¥</button></li>
        <li><button data-tab="publications">ğŸ“š ì €ì„œ</button></li>
        <li><button data-tab="courses">ğŸ“º ì›ê²©ì—°ìˆ˜</button></li>
        <li><button data-tab="awards">ğŸ† ìˆ˜ìƒ</button></li>
        <li><button data-tab="activities">ğŸ“Œ í™œë™</button></li>
        <li><button data-tab="press">ğŸ“° ë³´ë„ìë£Œ</button></li>
        <li><a href="index.html">â† ì‚¬ì´íŠ¸ë¡œ ì´ë™</a></li>
      </ul>
    </aside>
    <div class="main" id="mainContent"></div>
  </div>
  <div class="modal-overlay" id="modal">
    <div class="modal" id="modalBody"></div>
  </div>
  <div class="toast" id="toast"></div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
  <div id="loginOverlay"
    style="position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px">
    <div style="text-align:center">
      <div style="font-size:3rem;margin-bottom:20px">ğŸ”’</div>
      <h2 style="margin-bottom:10px">ê´€ë¦¬ì ì ‘ê·¼ ê¶Œí•œ í™•ì¸</h2>
      <p style="color:var(--text2);margin-bottom:24px">í˜ì´ì§€ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <input type="password" id="adminPw" class="form-input"
        style="width:280px;text-align:center;font-size:1.2rem;letter-spacing:4px" placeholder="Password" />
      <button class="btn btn-red" style="width:100%;margin-top:12px;padding:12px" onclick="checkAdmin()">ë¡œê·¸ì¸</button>
      <div id="loginMsg" style="color:#ef4444;margin-top:12px;font-size:.9rem;min-height:20px"></div>
    </div>
  </div>

  <script src="data.js"></script>
  <script>
    /* â”€â”€ ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ) â”€â”€ */
    (function () {
      const isAuth = localStorage.getItem('admin_auth');
      if (isAuth === 'true') {
        document.getElementById('loginOverlay').style.display = 'none';
      } else {
        document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ë°©ì§€
      }
    })();

    function checkAdmin() {
      const pw = document.getElementById('adminPw').value;
      const msg = document.getElementById('loginMsg');
      if (pw === 'dhdpswnl2@') {
        localStorage.setItem('admin_auth', 'true');
        document.getElementById('loginOverlay').style.display = 'none';
        document.body.style.overflow = '';
        showToast('ğŸ”“ ë¡œê·¸ì¸ ì„±ê³µ');
      } else {
        msg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        document.getElementById('adminPw').classList.add('shake');
        setTimeout(() => document.getElementById('adminPw').classList.remove('shake'), 400);
      }
    }

    document.getElementById('adminPw')?.addEventListener('keydown', e => {
      if (e.key === 'Enter') checkAdmin();
    });
    let D = profileData;
    const main = document.getElementById('mainContent');
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    const toast = document.getElementById('toast');
    let currentTab = 'dashboard';

    const REPO_OWNER = 'mj-lee-dj';
    const REPO_NAME = 'MinjaeLee-Profile';
    const FILE_PATH = 'profile-site/data.js';

    /* [GitHub ì—°ë™] ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ìµœì‹  ë°ì´í„° ë™ê¸°í™”) */
    (async function initAdmin() {
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í† í°ì´ ì—†ìœ¼ë©´ íŒ¨ìŠ¤ (ë˜ëŠ” í™•ì¸)
      // ìµœì‹  ë°ì´í„°ê°€ GitHubì— ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ raw URLì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
      try {
        const res = await fetch(`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${FILE_PATH}`);
        if (res.ok) {
          const text = await res.text();
          // JS íŒŒì¼ì—ì„œ JSON ë¶€ë¶„ ì¶”ì¶œ: const profileData = { ... };
          const match = text.match(/const profileData = ({[\s\S]*?});/);
          if (match && match[1]) {
            // JSON íŒŒì‹± (ì•ˆì „í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì§€ë§Œ Adminì´ë¯€ë¡œ í—ˆìš©)
            // Function ë“±ì€ ì—†ì„ ê²ƒìœ¼ë¡œ ê°€ì •
            // ë”°ì˜´í‘œ ë“±ì´ ì˜ ë§¤ì¹­ë˜ì–´ì•¼ í•¨. ë‹¨ìˆœ íŒŒì‹± ì‹œë„.
            // data.jsê°€ ê¸°ê³„ì ìœ¼ë¡œ ìƒì„±ëœ í‘œì¤€ JSON í¬ë§·ì´ë¼ë©´ ì„±ê³µí•¨.
            try {
              const remoteData = JSON.parse(match[1]);
              console.log('ğŸ“¦ Admin: Data loaded from GitHub');
              D = remoteData;
              if (currentTab === 'dashboard') renderDashboard();
            } catch (jsonErr) {
              console.warn('GitHub ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨ (ìˆ˜ë™ ìˆ˜ì •ë¨?):', jsonErr);
            }
          }
        }
      } catch (e) {
        console.warn('GitHub ì—°ê²° ì‹¤íŒ¨ (ë¡œì»¬ ë°ì´í„° ì‚¬ìš©):', e);
      }
    })();

    function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7) }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GitHub ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */


    let _saving = false; // ë™ì‹œ ì €ì¥ ë°©ì§€ ì ê¸ˆ

    async function save() {
      if (_saving) { showToast('â³ ì €ì¥ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...'); return; }
      _saving = true;

      let token = localStorage.getItem('gh_token');
      if (!token) {
        token = prompt('GitHub Personal Access Tokenì„ ì…ë ¥í•˜ì„¸ìš”.\n(repo ê¶Œí•œ í•„ìš”, í•œ ë²ˆ ì…ë ¥í•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤.)');
        if (!token) { _saving = false; return; }
        localStorage.setItem('gh_token', token);
      }

      const API = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}`;
      const headers = { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' };

      try {
        /* â”€â”€ 1ë‹¨ê³„: ìµœì‹  ì»¤ë°‹ & íŠ¸ë¦¬ SHA â”€â”€ */
        showToast('â˜ï¸ ì €ì¥ ì¤€ë¹„ ì¤‘...');
        const refRes = await fetch(`${API}/git/refs/heads/main`, { headers });
        if (!refRes.ok) {
          if (refRes.status === 401 || refRes.status === 403) {
            localStorage.removeItem('gh_token');
            throw new Error('í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
          }
          throw new Error('ë¸Œëœì¹˜ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
        }
        const latestCommitSha = (await refRes.json()).object.sha;
        const baseTreeSha = (await (await fetch(`${API}/git/commits/${latestCommitSha}`, { headers })).json()).tree.sha;

        /* â”€â”€ 2ë‹¨ê³„: base64 ì´ë¯¸ì§€ë¥¼ ê°œë³„ íŒŒì¼ë¡œ ì¶”ì¶œÂ·ì—…ë¡œë“œ â”€â”€ */
        const dataClone = JSON.parse(JSON.stringify(D));
        const treeEntries = [];       // íŠ¸ë¦¬ì— ì¶”ê°€í•  íŒŒì¼ ëª©ë¡
        const uploadCache = new Map(); // ì¤‘ë³µ ë°©ì§€ ìºì‹œ (hashKey â†’ url)
        let imgCount = 0;

        /* base64 ì´ë¯¸ì§€ URLì´ë©´ blobìœ¼ë¡œ ì—…ë¡œë“œí•˜ê³  GitHub raw URL ë°˜í™˜ */
        async function uploadIfBase64(val) {
          if (typeof val !== 'string' || !val.startsWith('data:image/')) return val;
          const m = val.match(/^data:image\/([^;]+);base64,(.+)$/s);
          if (!m) return val;
          const ext = m[1].replace('+xml', '').replace('jpeg', 'jpg');
          const b64 = m[2];

          /* ì¤‘ë³µ ì²´í¬ (base64 ì•ë¶€ë¶„+ê¸¸ì´ë¡œ í•´ì‹œ ìƒì„±) */
          const hashKey = b64.substring(0, 64) + '_' + b64.length;
          if (uploadCache.has(hashKey)) return uploadCache.get(hashKey);

          imgCount++;
          showToast(`ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘... (${imgCount}ì¥)`);

          const blobRes = await fetch(`${API}/git/blobs`, {
            method: 'POST', headers,
            body: JSON.stringify({ content: b64, encoding: 'base64' })
          });
          if (!blobRes.ok) {
            const err = await blobRes.json().catch(() => ({}));
            throw new Error(`ì´ë¯¸ì§€ ${imgCount} ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message || blobRes.status}`);
          }
          const blob = await blobRes.json();
          const filePath = `profile-site/uploads/${blob.sha.substring(0, 12)}.${ext}`;
          const rawUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${filePath}`;

          treeEntries.push({ path: filePath, mode: '100644', type: 'blob', sha: blob.sha });
          uploadCache.set(hashKey, rawUrl);
          return rawUrl;
        }

        /* ê°ì²´ ì „ì²´ë¥¼ ìˆœíšŒí•˜ë©° base64 ì´ë¯¸ì§€ ì¶”ì¶œ */
        async function processObj(obj) {
          if (!obj || typeof obj !== 'object') return;
          const keys = Array.isArray(obj) ? obj.keys() : Object.keys(obj);
          for (const k of keys) {
            if (typeof obj[k] === 'string') {
              obj[k] = await uploadIfBase64(obj[k]);
            } else if (typeof obj[k] === 'object') {
              await processObj(obj[k]);
            }
          }
        }

        await processObj(dataClone);

        /* â”€â”€ 3ë‹¨ê³„: ì¶•ì†Œëœ data.js blob ìƒì„± â”€â”€ */
        showToast('ğŸ“„ ë°ì´í„° íŒŒì¼ ì €ì¥ ì¤‘...');
        const newContent = `/* \n  [Profile Data] \n  Updated at: ${new Date().toISOString()} \n*/\nconst profileData = ${JSON.stringify(dataClone)};\n`;

        const dataBlobRes = await fetch(`${API}/git/blobs`, {
          method: 'POST', headers,
          body: JSON.stringify({ content: newContent, encoding: 'utf-8' })
        });
        if (!dataBlobRes.ok) {
          const err = await dataBlobRes.json().catch(() => ({}));
          throw new Error(`ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ${err.message || dataBlobRes.status}`);
        }
        treeEntries.push({ path: FILE_PATH, mode: '100644', type: 'blob', sha: (await dataBlobRes.json()).sha });

        /* â”€â”€ 4ë‹¨ê³„: íŠ¸ë¦¬ ìƒì„± â”€â”€ */
        const treeRes = await fetch(`${API}/git/trees`, {
          method: 'POST', headers,
          body: JSON.stringify({ base_tree: baseTreeSha, tree: treeEntries })
        });
        if (!treeRes.ok) throw new Error('íŠ¸ë¦¬ ìƒì„± ì‹¤íŒ¨');

        /* â”€â”€ 5ë‹¨ê³„: ì»¤ë°‹ ìƒì„± â”€â”€ */
        const commitRes = await fetch(`${API}/git/commits`, {
          method: 'POST', headers,
          body: JSON.stringify({
            message: `Update profile data via Admin (${new Date().toLocaleDateString()})`,
            tree: (await treeRes.json()).sha,
            parents: [latestCommitSha]
          })
        });
        if (!commitRes.ok) throw new Error('ì»¤ë°‹ ìƒì„± ì‹¤íŒ¨');

        /* â”€â”€ 6ë‹¨ê³„: Ref ì—…ë°ì´íŠ¸ (Push) â”€â”€ */
        const updateRes = await fetch(`${API}/git/refs/heads/main`, {
          method: 'PATCH', headers,
          body: JSON.stringify({ sha: (await commitRes.json()).sha })
        });
        if (!updateRes.ok) throw new Error('Push ì‹¤íŒ¨');

        showToast(`âœ… ì €ì¥ ì„±ê³µ! (ì´ë¯¸ì§€ ${imgCount}ì¥ ë¶„ë¦¬ ì €ì¥ë¨)`);
        saveProfileData(D);

      } catch (e) {
        console.error(e);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + e.message);
        showToast('âŒ ì €ì¥ ì‹¤íŒ¨');
      } finally {
        _saving = false;
      }
    }
    function saveProfileData(data) {
      try {
        localStorage.setItem('profileData', JSON.stringify(data));
        console.log('ğŸ“¦ Local Backup Saved');
      } catch (e) {
        console.warn('âš ï¸ Local Storage Full (Backup skipped):', e);
        // ì €ì¥ ìš©ëŸ‰ ì´ˆê³¼ ì—ëŸ¬ëŠ” ë¬´ì‹œ (GitHubì—ëŠ” ì´ë¯¸ ì €ì¥ë¨)
        if (e.name === 'QuotaExceededError') {
          console.log('Local Storage Quota Exceeded');
        }
      }
    }

    function showToast(msg) { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2200) }
    function openModal(html) { modalBody.innerHTML = html; modal.classList.add('open') }
    function closeModal() { modal.classList.remove('open') }
    // modal.addEventListener('click', e => { if (e.target === modal) closeModal() }); // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° ë°©ì§€
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal() });

    /* â”€â”€ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€ */
    document.getElementById('sideNav').addEventListener('click', e => {
      const btn = e.target.closest('button[data-tab]'); if (!btn) return;
      document.querySelectorAll('.sidebar-nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active'); currentTab = btn.dataset.tab; render();
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë§í¬ ë¯¸ë¦¬ë³´ê¸° ê°€ì ¸ì˜¤ê¸° ìœ í‹¸
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* YouTube ë¹„ë””ì˜¤ ID ì¶”ì¶œ */
    function getYouTubeId(url) {
      if (!url) return null;
      const m = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|shorts\/)|youtu\.be\/)([\w-]{11})/);
      return m ? m[1] : null;
    }

    /* YouTube ì¸ë„¤ì¼ URL ìƒì„± */
    function getYouTubeThumbnail(videoId) {
      return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    }

    /* Microlink APIë¡œ OG ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¬´ë£Œ í‹°ì–´) */
    async function fetchLinkPreview(url) {
      if (!url) throw new Error('URLì´ ì—†ìŠµë‹ˆë‹¤.');

      /* YouTubeì¸ ê²½ìš° ë°”ë¡œ ì¸ë„¤ì¼ ë°˜í™˜ */
      const ytId = getYouTubeId(url);
      if (ytId) {
        return {
          title: '',
          description: 'YouTube ì˜ìƒ',
          images: [
            `https://img.youtube.com/vi/${ytId}/maxresdefault.jpg`,
            `https://img.youtube.com/vi/${ytId}/hqdefault.jpg`
          ]
        };
      }

      /* ì¼ë°˜ URL â†’ Microlink API */
      const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
      const res = await fetch(apiUrl);
      const json = await res.json();

      if (json.status !== 'success') throw new Error('ë¯¸ë¦¬ë³´ê¸°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      const d = json.data;
      const images = [];
      if (d.image?.url) images.push(d.image.url);
      if (d.logo?.url && images.length < 3) images.push(d.logo.url);

      return {
        title: d.title || '',
        description: d.description || '',
        images
      };
    }

    /* â”€â”€ ë§í¬/íŒŒì¼ì—ì„œ AI ìë™ ì…ë ¥ í•¸ë“¤ëŸ¬ (ëª¨ë‹¬ ë‚´) â”€â”€ */
    /* PDFì—ì„œ ì „ì²´ í…ìŠ¤íŠ¸ ì¶”ì¶œ (pdf.js ì‚¬ìš©) */
    async function extractTextFromPdf(data) {
      const loadingTask = pdfjsLib.getDocument(data);
      const pdf = await loadingTask.promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      return fullText;
    }

    function getGoogleDriveId(url) {
      if (!url) return null;
      const m = url.match(/[-\w]{25,}/);
      return m ? m[0] : null;
    }

    /* â”€â”€ ë§í¬/íŒŒì¼ì—ì„œ AI ìë™ ì…ë ¥ í•¸ë“¤ëŸ¬ (ëª¨ë‹¬ ë‚´) â”€â”€ */
    async function handleFetchPreview() {
      const urlInput = document.getElementById('f_link');
      const url = urlInput?.value?.trim();
      if (!url) return alert('ë§í¬ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');

      const resultArea = document.getElementById('previewResult');
      resultArea.innerHTML = '<span class="fetching">ğŸ”„ ë§í¬ ë¶„ì„ ë° ë°ì´í„° ì¶”ì¶œ ì¤‘...</span>';

      try {
        let contentText = '';
        let title = '';
        const driveId = getGoogleDriveId(url);

        /* 1) Google Drive ë§í¬ì¸ ê²½ìš° (ê¶Œí•œ í•„ìš”) */
        if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
          if (!accessToken) {
            // í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ìœ ë„
            await new Promise((resolve) => {
              tokenClient.callback = (resp) => {
                if (resp.error) throw resp;
                accessToken = resp.access_token;
                resolve();
              };
              tokenClient.requestAccessToken({ prompt: '' }); // íŒì—… ì—†ì´ ì‹œë„, ì•ˆë˜ë©´ íŒì—…
            });
          }
          if (!gapi.client.drive) await gapi.client.load('drive', 'v3');

          /* ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸° */
          const meta = await gapi.client.drive.files.get({ fileId: driveId, fields: 'id, name, mimeType, description' });
          title = meta.result.name;

          /* ë‚´ìš© ê°€ì ¸ì˜¤ê¸° */
          if (meta.result.mimeType.includes('google-apps')) {
            const res = await gapi.client.drive.files.export({ fileId: driveId, mimeType: 'text/plain' });
            contentText = res.body;
          } else if (meta.result.mimeType.includes('pdf')) {
            resultArea.innerHTML = '<span class="fetching">ğŸ“„ PDF ì „ì²´ í˜ì´ì§€ ì½ëŠ” ì¤‘... (ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</span>';
            const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${driveId}?alt=media`, { headers: { 'Authorization': 'Bearer ' + accessToken } });
            const blob = await resp.blob();
            const arrayBuffer = await blob.arrayBuffer();
            contentText = await extractTextFromPdf(new Uint8Array(arrayBuffer));
          } else {
            // ê·¸ ì™¸ íŒŒì¼ì€ ë©”íƒ€ë°ì´í„° ì„¤ëª…ë§Œ ì‚¬ìš©
            contentText = meta.result.description || '';
          }
        }

        /* 2) ì¼ë°˜ URLì¸ ê²½ìš° (Microlink) */
        const preview = await fetchLinkPreview(url); // ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš© (ì´ë¯¸ì§€/íŒŒë¹„ì½˜ ë“±)
        if (!title) title = preview.title;

        /* 3) Gemini APIë¡œ ì „ë¬¸ì ì¸ ìš”ì•½ ìƒì„± */
        const apiKey = getApiKey();
        if (apiKey) {
          resultArea.innerHTML = '<span class="fetching">ğŸ¤– AIê°€ ì „ì²´ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì „ë¬¸ì ì¸ ìš”ì•½ ì‘ì„± ì¤‘...</span>';

          /* í”„ë¡¬í”„íŠ¸ ê°•í™”: 100ì ë‚´ì™¸, ì „ë¬¸ì , ë§¤ë ¥ì  */
          const prompt = `
ë‹¤ìŒ ìë£Œì˜ ì „ì²´ ë‚´ìš©(í…ìŠ¤íŠ¸)ì„ ë¶„ì„í•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ì— ë“¤ì–´ê°ˆ 'ì „ë¬¸ì ì´ê³  ë§¤ë ¥ì ì¸ ì„¤ëª…'ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
ìë£Œ URL: ${url}
ì œëª©: ${title}
ì „ì²´ í…ìŠ¤íŠ¸ ë‚´ìš©:
${contentText ? contentText.slice(0, 15000) : 'ë‚´ìš© ì—†ìŒ (ì œëª© ë° ë©”íƒ€ë°ì´í„° ì°¸ì¡°: ' + (preview.description || '') + ')'}

[ìš”ì²­ ì‚¬í•­]
1. ë‹¨ìˆœí•œ ë‚´ìš© ìš”ì•½ì´ ì•„ë‹ˆë¼, ì´ ìë£Œê°€ ì–´ë–¤ ê°€ì¹˜ë¥¼ ì œê³µí•˜ëŠ”ì§€, ì–´ë–¤ ì „ë¬¸ì„±ì„ ë³´ì—¬ì£¼ëŠ”ì§€ ê°•ì¡°í•˜ì„¸ìš”.
2. ë¬¸ì²´ëŠ” 'ì „ë¬¸ê°€ìŠ¤ëŸ¬ìš´', 'ì‹ ë¢°ê°ì„ ì£¼ëŠ”', 'ì •ì œëœ' í†¤ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (í•´ìš”ì²´ë³´ë‹¤ëŠ” 'í•¨/ìŒ'ì²´ë‚˜ ëª…ì‚¬í˜• ì¢…ê²° ì¶”ì²œ, ë˜ëŠ” ê²©ì‹ìˆëŠ” í•´ìš”ì²´)
3. ë¶„ëŸ‰ì€ ê³µë°± í¬í•¨ **100ì ë‚´ì™¸**ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ í•µì‹¬ë§Œ ì„íŒ©íŠ¸ ìˆê²Œ.
4. ê¸°ì¡´ í…ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ê³ , **ì™„ì „íˆ ìƒˆë¡œ ë§¤ë ¥ì ìœ¼ë¡œ ì‘ì„±**í•˜ì„¸ìš”.

ì‘ë‹µ í˜•ì‹ (JSON):
{"title":"ì œëª©(í•„ìš”ì‹œ ë‹¤ë“¬ìŒ)","org":"ê¸°ê´€/ì¶œíŒì‚¬","year":2025,"description":"ì „ë¬¸ì ì¸ ì„¤ëª… ë‚´ìš© (100ì ë‚´ì™¸)","tags":["íƒœê·¸1","íƒœê·¸2"],"source":"ì¶œì²˜","date":"ë‚ ì§œ"}
`;
          try {
            const aiResult = await callGeminiText(prompt);
            autoFillFormFields(aiResult, preview);
          } catch (e) {
            console.error(e);
            autoFillFormFields({ title, description: 'AI ë¶„ì„ ì‹¤íŒ¨: ' + e.message }, preview);
          }
        } else {
          autoFillFormFields({ title, description: preview.description }, preview);
        }

        /* ê²°ê³¼ í‘œì‹œ */
        resultArea.innerHTML = `
          <div style="font-size:.82rem;color:var(--green);margin-bottom:8px">âœ… AI ì •ë°€ ë¶„ì„ ì™„ë£Œ! (ì „ì²´ í…ìŠ¤íŠ¸ ê¸°ë°˜)</div>
          <div class="preview-desc">${document.getElementById('f_preview_desc').value}</div>
          <div class="img-list">${preview.images.map(img => `<div class="img-list-item"><img src="${img}" onerror="this.parentElement.remove()"/></div>`).join('')}</div>
        `;
        refreshImageList();

      } catch (err) {
        console.error(err);
        resultArea.innerHTML = `<span style="color:#ef4444;font-size:.85rem">âŒ ì˜¤ë¥˜: ${err.message} (ê¶Œí•œ ë¬¸ì œì¼ ê²½ìš° 'Select from Drive' ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ë³´ì„¸ìš”)</span>`;
      }
    }

    /* ëª¨ë‹¬ ë‚´ íŒŒì¼ ì—…ë¡œë“œ â†’ AI ë¶„ì„ â†’ í¼ ìë™ ì±„ìš°ê¸° */
    async function handleFormFileUpload() {
      const input = document.getElementById('f_file_upload');
      const file = input?.files?.[0];
      if (!file) return;

      /* PDFì¸ ê²½ìš° í˜ì´ì§€ ì„ íƒê¸° í˜¸ì¶œ */
      if (file.type === 'application/pdf') {
        const reader = new FileReader();
        reader.onload = function (e) {
          openPageSelector(new Uint8Array(e.target.result));
        };
        reader.readAsArrayBuffer(file);
        return;
      }

      const apiKey = getApiKey();
      if (!apiKey) return alert('Gemini API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.\n(ëŒ€ì‹œë³´ë“œ â†’ ìë™ ë“±ë¡ íƒ­ì—ì„œ ì„¤ì • ê°€ëŠ¥)');

      const resultArea = document.getElementById('previewResult');
      resultArea.innerHTML = `<span class="fetching">ğŸ¤– "${file.name}" AI ë¶„ì„ ì¤‘...</span>`;

      try {
        const base64 = await fileToBase64(file);
        const mime = file.type || 'image/jpeg';
        const aiResult = await callGeminiVision(base64, mime);

        /* ì´ë¯¸ì§€ë¥¼ ì´ë¯¸ì§€ ëª©ë¡ì— ì¶”ê°€ (base64 data URL) */
        const dataUrl = base64ToDataUrl(base64, mime);
        const imgInput = document.getElementById('f_images_data');
        let imgs = [];
        try { imgs = JSON.parse(imgInput.value || '[]'); } catch (e) { }
        imgs.push(dataUrl);
        imgInput.value = JSON.stringify(imgs);

        autoFillFormFields(aiResult, { title: aiResult.title, description: aiResult.description, images: [dataUrl] });

        resultArea.innerHTML = `
          <div style="font-size:.82rem;color:var(--green);margin-bottom:8px">âœ… AI ë¶„ì„ ì™„ë£Œ! í¼ì´ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
          <div class="img-list"><div class="img-list-item"><img src="${dataUrl}"/></div></div>
        `;
        refreshImageList();
      } catch (err) {
        resultArea.innerHTML = `<span style="color:#ef4444;font-size:.85rem">âŒ ${err.message}</span>`;
      }
      input.value = '';
    }

    /* í¼ í•„ë“œ ìë™ ì±„ìš°ê¸° (ë¹„ì–´ìˆëŠ” í•„ë“œë§Œ) */
    function autoFillFormFields(data, preview) {
      const fill = (id, val) => { const el = document.getElementById(id); if (el && !el.value.trim() && val) el.value = val; };
      fill('f_title', data.title);
      fill('f_org', data.org || data.source);
      fill('f_pub', data.org);
      fill('f_source', data.source || data.org);
      fill('f_year', data.year);
      fill('f_date', data.date);
      fill('f_desc', data.description);
      fill('f_preview_desc', data.description);
      if (data.tags?.length) fill('f_tags', data.tags.join(', '));
    }

    /* ì´ë¯¸ì§€ ëª©ë¡ ë¦¬í”„ë ˆì‹œ (ëª¨ë‹¬ ë‚´) â€” ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë“œë˜ê·¸ì•¤ë“œë¡­ ì§€ì› */
    function refreshImageList() {
      const imgInput = document.getElementById('f_images_data');
      const container = document.getElementById('imageListView');
      if (!imgInput || !container) return;
      let images = [];
      try { images = JSON.parse(imgInput.value || '[]'); } catch (e) { }
      container.innerHTML = images.map((img, i) => `
        <div class="img-list-item" data-img-idx="${i}">
          <img src="${img}" draggable="false" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2240%22><rect fill=%22%23333%22 width=%2260%22 height=%2240%22/><text x=%2230%22 y=%2224%22 text-anchor=%22middle%22 fill=%22%23777%22 font-size=%228%22>ì˜¤ë¥˜</text></svg>'"/>
          <button class="remove-img" onclick="removeImage(${i})">âœ•</button>
        </div>
      `).join('');
      /* ì´ë¯¸ì§€ ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸ ë°”ì¸ë”© */
      setupImageMouseDrag(container);
    }

    /* ì´ë¯¸ì§€ ìˆœìˆ˜ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ê¸°ë°˜ ë“œë˜ê·¸ì•¤ë“œë¡­ */
    function setupImageMouseDrag(container) {
      const items = Array.from(container.querySelectorAll('.img-list-item'));
      items.forEach(el => {
        el.style.cursor = 'grab';
        el.addEventListener('mousedown', e => {
          if (e.target.closest('.remove-img')) return; /* ì‚­ì œ ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ */
          e.preventDefault();
          const fromIdx = +el.dataset.imgIdx;
          let currentOverEl = null;
          el.classList.add('img-dragging');
          el.style.cursor = 'grabbing';

          function onMouseMove(ev) {
            items.forEach(x => x.classList.remove('img-drag-over'));
            const target = document.elementFromPoint(ev.clientX, ev.clientY)?.closest('.img-list-item');
            if (target && target !== el) {
              target.classList.add('img-drag-over');
              currentOverEl = target;
            } else {
              currentOverEl = null;
            }
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            el.classList.remove('img-dragging');
            el.style.cursor = 'grab';
            items.forEach(x => x.classList.remove('img-drag-over'));

            if (currentOverEl) {
              const toIdx = +currentOverEl.dataset.imgIdx;
              if (fromIdx !== toIdx) {
                const imgInput = document.getElementById('f_images_data');
                let images = [];
                try { images = JSON.parse(imgInput.value || '[]'); } catch (ex) { }
                const [moved] = images.splice(fromIdx, 1);
                images.splice(toIdx, 0, moved);
                imgInput.value = JSON.stringify(images);
                refreshImageList();
                showToast('ğŸ–¼ï¸ ì´ë¯¸ì§€ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
              }
            }
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    function removeImage(index) {
      const imgInput = document.getElementById('f_images_data');
      let images = [];
      try { images = JSON.parse(imgInput.value || '[]'); } catch (e) { }
      images.splice(index, 1);
      imgInput.value = JSON.stringify(images);
      refreshImageList();
    }

    function addManualImage() {
      const url = document.getElementById('f_new_image_url')?.value?.trim();
      if (!url) return;
      const imgInput = document.getElementById('f_images_data');
      let images = [];
      try { images = JSON.parse(imgInput.value || '[]'); } catch (e) { }
      if (!images.includes(url)) images.push(url);
      imgInput.value = JSON.stringify(images);
      document.getElementById('f_new_image_url').value = '';
      refreshImageList();
    }

    /* í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì§€ì› */
    function setupClipboardPaste() {
      const modal = document.getElementById('modal');
      if (!modal) return;
      /* ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ named function ì‚¬ìš© */
      modal._pasteHandler && modal.removeEventListener('paste', modal._pasteHandler);
      modal._pasteHandler = async function (e) {
        const items = e.clipboardData?.items;
        if (!items) return;
        for (const item of items) {
          if (item.type.startsWith('image/')) {
            e.preventDefault();
            const file = item.getAsFile();
            if (!file) continue;
            const reader = new FileReader();
            reader.onload = () => {
              const dataUrl = reader.result;
              const imgInput = document.getElementById('f_images_data');
              if (!imgInput) return;
              let imgs = [];
              try { imgs = JSON.parse(imgInput.value || '[]'); } catch (ex) { }
              imgs.push(dataUrl);
              imgInput.value = JSON.stringify(imgs);
              refreshImageList();
              showToast('ğŸ“‹ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            };
            reader.readAsDataURL(file);
            break;
          }
        }
      };
      modal.addEventListener('paste', modal._pasteHandler);
    }

    /* â”€â”€ ì´ë¯¸ì§€ & ë§í¬ ê´€ë¦¬ìš© ê³µí†µ í¼ HTML â”€â”€ */
    function linkPreviewFormHTML(item) {
      const images = item?.images || [];
      const hasKey = !!getApiKey();
      return `
        <div class="form-row" style="margin-top:8px">
          <label class="form-label" style="font-size:.9rem">ğŸ”— ê´€ë ¨ ë§í¬ (ì™¸ë¶€ ê³µê°œ)</label>
          <div class="form-hint" style="margin-bottom:8px">ì—¬ê¸°ì— ì…ë ¥í•œ ë§í¬ê°€ í¬íŠ¸í´ë¦¬ì˜¤ ì‚¬ì´íŠ¸ì˜ <strong>'ë³´ê¸°' ë²„íŠ¼</strong>ì— ì—°ê²°ë©ë‹ˆë‹¤.</div>
          <input class="form-input" id="f_view_link" value="${item?.link || ''}" placeholder="ê³µê°œí•  ë§í¬ ì…ë ¥ (YouTube, ë‰´ìŠ¤ê¸°ì‚¬, ì›¹ì‚¬ì´íŠ¸ ë“±)"/>
        </div>
        <div class="form-row" style="background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-top:8px">
          <label class="form-label" style="font-size:.9rem;color:var(--red);margin-bottom:12px">ğŸ¤– AI ìë™ ì…ë ¥ (ë¶„ì„ ì „ìš©)</label>
          <div class="form-hint" style="margin-bottom:8px">ì—¬ê¸°ì— ì…ë ¥í•œ ë§í¬ëŠ” <strong>AI ë¶„ì„ì—ë§Œ</strong> ì‚¬ìš©ë˜ë©°, ì™¸ë¶€ì— ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
          <div class="link-row">
            <input class="form-input" id="f_link" value="" placeholder="AI ë¶„ì„í•  ë§í¬ (êµì•ˆ, êµ¬ê¸€ë…ìŠ¤ ë“± - ì™¸ë¶€ì— ê³µê°œë˜ì§€ ì•ŠìŒ)"/>
            <button class="btn btn-red btn-sm fetch-btn" type="button" onclick="handleFetchPreview()">ğŸ” ìë™ ê°€ì ¸ì˜¤ê¸° (AI)</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <label class="btn btn-outline btn-sm" style="cursor:pointer">
              ğŸ“„ íŒŒì¼ë¡œ AI ë¶„ì„
              <input type="file" id="f_file_upload" accept="image/*,.pdf" style="display:none" onchange="handleFormFileUpload()"/>
            </label>
            <button class="btn btn-outline btn-sm" onclick="handleAuthClick()">â˜ï¸ Driveì—ì„œ ì„ íƒ</button>
            <span class="form-hint" style="margin:0">${hasKey ? 'âœ… API í‚¤ ì„¤ì •ë¨' : 'âš ï¸ API í‚¤ í•„ìš”'}</span>
          </div>
          <div id="previewResult"></div>
        </div>
        <div class="form-row">
          <label class="form-label">ğŸ“ ë¯¸ë¦¬ë³´ê¸° ì„¤ëª…</label>
          <textarea class="form-textarea" id="f_preview_desc" placeholder="ë§í¬ì—ì„œ ìë™ ì¶”ì¶œë˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”">${item?.previewDesc || ''}</textarea>
        </div>
        <div class="form-row">
          <label class="form-label">ğŸ–¼ï¸ ì´ë¯¸ì§€ ëª©ë¡</label>
          <div class="form-hint">ë§í¬/íŒŒì¼ì—ì„œ ìë™ ì¶”ì¶œë˜ê±°ë‚˜, ì•„ë˜ì— ì§ì ‘ ì´ë¯¸ì§€ URLì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/><strong>ğŸ“‹ Ctrl+Vë¡œ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ë¥¼ ë°”ë¡œ ë¶™ì—¬ë„£ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</strong></div>
          <div id="imageListView" class="img-list" style="margin-top:8px"></div>
          <input type="hidden" id="f_images_data" value='${JSON.stringify(images)}'/>
          <div class="link-row" style="margin-top:8px">
            <input class="form-input" id="f_new_image_url" placeholder="ì´ë¯¸ì§€ URL ì§ì ‘ ì¶”ê°€"/>
            <button class="btn btn-outline btn-sm" type="button" onclick="addManualImage()">ì¶”ê°€</button>
          </div>
        </div>
      `;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ëŒ€ì‹œë³´ë“œ
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderDashboard() {
      const withImages = [...D.lectures, ...D.press, ...D.publications].filter(i => i.images?.length > 0).length;
      const withLinks = [...D.lectures, ...D.press, ...D.publications].filter(i => i.link).length;
      main.innerHTML = `
        <div class="page-header"><div class="page-title">ëŒ€ì‹œë³´ë“œ</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-red" onclick="save()">â˜ï¸ GitHubì— ì €ì¥</button>
            <button class="btn btn-outline" onclick="resetData()">ğŸ”„ ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="stat-cards">
          <div class="stat-card"><div class="sc-val">${D.lectures.length}</div><div class="sc-label">ê°•ì˜Â·ì—°ìˆ˜</div></div>
          <div class="stat-card"><div class="sc-val">${D.publications.length}</div><div class="sc-label">ì €ì„œ</div></div>
          <div class="stat-card"><div class="sc-val">${D.awards.length}</div><div class="sc-label">ìˆ˜ìƒ</div></div>
          <div class="stat-card"><div class="sc-val">${D.press.length}</div><div class="sc-label">ë³´ë„ìë£Œ</div></div>
        </div>
        <div style="display:flex;gap:16px;flex-wrap:wrap">
          <div class="stat-card" style="flex:1;min-width:180px"><div class="sc-val" style="color:var(--blue)">${withLinks}</div><div class="sc-label">ë§í¬ ë“±ë¡ í•­ëª©</div></div>
          <div class="stat-card" style="flex:1;min-width:180px"><div class="sc-val" style="color:var(--green)">${withImages}</div><div class="sc-label">ì´ë¯¸ì§€ í¬í•¨ í•­ëª©</div></div>
        </div>
        <a href="index.html" class="preview-link" target="_blank" style="margin-top:20px">ğŸ–¥ í¬íŠ¸í´ë¦¬ì˜¤ ì‚¬ì´íŠ¸ ë¯¸ë¦¬ë³´ê¸° â†’</a>
      `;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê°•ì˜ ê´€ë¦¬
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderLectures() {
      main.innerHTML = `
        <div class="page-header">
          <div class="page-title">ê°•ì˜Â·ì—°ìˆ˜ ì´ë ¥ <small>${D.lectures.length}ê±´</small></div>
          <button class="btn btn-red" onclick="openLecForm()">+ ê°•ì˜ ì¶”ê°€</button>
        </div>
        <table class="data-table">
          <thead><tr><th style="width:36px"></th><th></th><th>ì—°ë„</th><th>ì œëª©</th><th>ê¸°ê´€</th><th>ì¹´í…Œê³ ë¦¬</th><th>ë¶€ê°€</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="lecTbody">
            ${D.lectures.map((l, i) => `<tr data-idx="${i}">
              <td><span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</span></td>
              <td>${l.images?.length ? `<img src="${l.images[0]}" class="td-thumb" onerror="this.style.display='none'"/>` : ''}</td>
              <td>${l.year}</td>
              <td>${l.title}</td>
              <td style="color:var(--text2);max-width:160px">${l.org || '-'}</td>
              <td>${l.category}</td>
              <td>
                ${l.highlight ? '<span class="hl-badge">â˜…</span> ' : ''}
                ${l.link ? '<span class="link-badge">ğŸ”—</span> ' : ''}
                ${l.images?.length ? `<span class="img-badge">ğŸ–¼${l.images.length}</span>` : ''}
              </td>
              <td class="actions">
                <button class="btn btn-outline btn-sm" onclick="openLecForm('${l.id}')">ìˆ˜ì •</button>
                <button class="btn btn-danger btn-sm" onclick="delItem('lectures','${l.id}')">ì‚­ì œ</button>
              </td>
            </tr>`).join('')}
          </tbody>
        </table>
      `;
      setupTableDragDrop('lecTbody', 'lectures');
    }

    function openLecForm(id) {
      const item = id ? D.lectures.find(l => l.id === id) : null;
      const cats = ['Google/Gemini', 'ChatGPT/AI', 'ì—ë“€í…Œí¬', 'ë©”íƒ€ë²„ìŠ¤/VR', 'í•™ê¸‰ê²½ì˜', 'ê¸°ì¡°ê°•ì—°/ë°œí‘œ'];
      openModal(`
        <h3>${item ? 'ê°•ì˜ ìˆ˜ì •' : 'ê°•ì˜ ì¶”ê°€'}</h3>
        <div class="form-row"><label class="form-label">ì œëª© *</label><input class="form-input" id="f_title" value="${item?.title || ''}"/></div>
        <div class="form-row"><label class="form-label">ê¸°ê´€/ì„¤ëª…</label><input class="form-input" id="f_org" value="${item?.org || ''}"/></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-row"><label class="form-label">ì—°ë„ *</label><input class="form-input" id="f_year" type="number" value="${item?.year || new Date().getFullYear()}"/></div>
          <div class="form-row"><label class="form-label">ì¹´í…Œê³ ë¦¬ *</label>
            <select class="form-select" id="f_cat">${cats.map(c => `<option value="${c}" ${item?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
          </div>
        </div>
        <div class="form-row"><label class="form-check"><input type="checkbox" id="f_hl" ${item?.highlight ? 'checked' : ''}/> ì£¼ìš” ì´ë ¥ìœ¼ë¡œ í‘œì‹œ</label></div>
        ${linkPreviewFormHTML(item)}
        <div class="form-actions">
          <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-red" onclick="saveLec('${id || ''}')">${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</button>
        </div>
      `);
      refreshImageList();
      setupClipboardPaste();
    }

    function saveLec(id) {
      let images = [];
      try { images = JSON.parse(document.getElementById('f_images_data').value || '[]'); } catch (e) { }
      const obj = {
        id: id || 'l_' + uid(),
        title: document.getElementById('f_title').value.trim(),
        org: document.getElementById('f_org').value.trim(),
        year: +document.getElementById('f_year').value,
        category: document.getElementById('f_cat').value,
        link: document.getElementById('f_view_link').value.trim(),
        previewDesc: document.getElementById('f_preview_desc').value.trim(),
        images,
        image: images[0] || '',
        highlight: document.getElementById('f_hl').checked
      };
      if (!obj.title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if (id) { const idx = D.lectures.findIndex(l => l.id === id); D.lectures[idx] = obj; }
      else { D.lectures.unshift(obj); }
      save(); closeModal(); render();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì €ì„œ ê´€ë¦¬
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderPublications() {
      main.innerHTML = `
        <div class="page-header">
          <div class="page-title">ì €ì„œ <small>${D.publications.length}ê¶Œ</small></div>
          <button class="btn btn-red" onclick="openPubForm()">+ ì €ì„œ ì¶”ê°€</button>
        </div>
        <table class="data-table">
          <thead><tr><th style="width:36px"></th><th></th><th>ì—°ë„</th><th>ì œëª©</th><th>ì¶œíŒì‚¬</th><th>ë¶€ê°€</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="pubTbody">
            ${D.publications.map((p, i) => `<tr data-idx="${i}">
              <td><span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</span></td>
              <td>${p.images?.length ? `<img src="${p.images[0]}" class="td-thumb"/>` : (p.image ? `<img src="${p.image}" class="td-thumb"/>` : '')}</td>
              <td>${p.year}</td><td>${p.title}</td><td style="color:var(--text2)">${p.publisher}</td>
              <td>${p.link ? '<span class="link-badge">ğŸ”—</span> ' : ''}${(p.images?.length || p.image) ? '<span class="img-badge">ğŸ–¼</span>' : ''}</td>
              <td class="actions">
                <button class="btn btn-outline btn-sm" onclick="openPubForm('${p.id}')">ìˆ˜ì •</button>
                <button class="btn btn-danger btn-sm" onclick="delItem('publications','${p.id}')">ì‚­ì œ</button>
              </td>
            </tr>`).join('')}
          </tbody>
        </table>
      `;
      setupTableDragDrop('pubTbody', 'publications');
    }

    function openPubForm(id) {
      const item = id ? D.publications.find(p => p.id === id) : null;
      const existingImages = item?.images || (item?.image ? [item.image] : []);
      const fakeItem = { ...item, images: existingImages };
      openModal(`
        <h3>${item ? 'ì €ì„œ ìˆ˜ì •' : 'ì €ì„œ ì¶”ê°€'}</h3>
        <div class="form-row"><label class="form-label">ì œëª© *</label><input class="form-input" id="f_title" value="${item?.title || ''}"/></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-row"><label class="form-label">ì¶œíŒì‚¬</label><input class="form-input" id="f_pub" value="${item?.publisher || ''}"/></div>
          <div class="form-row"><label class="form-label">ì—°ë„</label><input class="form-input" id="f_year" type="number" value="${item?.year || new Date().getFullYear()}"/></div>
        </div>
        <div class="form-row"><label class="form-label">ì„¤ëª…</label><textarea class="form-textarea" id="f_desc">${item?.description || ''}</textarea></div>
        <div class="form-row"><label class="form-label">íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label><input class="form-input" id="f_tags" value="${item?.tags?.join(', ') || ''}"/></div>
        ${linkPreviewFormHTML(fakeItem)}
        <div class="form-actions">
          <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-red" onclick="savePub('${id || ''}')">${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</button>
        </div>
      `);
      refreshImageList();
      setupClipboardPaste();
    }

    function savePub(id) {
      let images = [];
      try { images = JSON.parse(document.getElementById('f_images_data').value || '[]'); } catch (e) { }
      const obj = {
        id: id || 'pub_' + uid(),
        title: document.getElementById('f_title').value.trim(),
        publisher: document.getElementById('f_pub').value.trim(),
        year: +document.getElementById('f_year').value,
        description: document.getElementById('f_desc').value.trim(),
        tags: document.getElementById('f_tags').value.split(',').map(s => s.trim()).filter(Boolean),
        link: document.getElementById('f_view_link').value.trim(),
        previewDesc: document.getElementById('f_preview_desc').value.trim(),
        images,
        image: images[0] || ''
      };
      if (!obj.title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if (id) { const idx = D.publications.findIndex(p => p.id === id); D.publications[idx] = obj; }
      else { D.publications.unshift(obj); }
      save(); closeModal(); render();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì›ê²©ì—°ìˆ˜
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderCourses() {
      main.innerHTML = `
        <div class="page-header"><div class="page-title">ì›ê²©ì—°ìˆ˜ <small>${D.onlineCourses.length}ê±´</small></div>
          <button class="btn btn-red" onclick="openCourseForm()">+ ì¶”ê°€</button></div>
        <table class="data-table"><thead><tr><th style="width:36px"></th><th></th><th>ì œëª©</th><th>í”Œë«í¼</th><th>í•™ì </th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="courseTbody">${D.onlineCourses.map((c, i) => `<tr data-idx="${i}">
          <td><span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</span></td>
          <td>${c.images?.length ? `<img src="${c.images[0]}" class="td-thumb"/>` : (c.image ? `<img src="${c.image}" class="td-thumb"/>` : '')}</td>
          <td>${c.title}</td><td>${c.platform}</td><td>${c.credit}</td>
          <td class="actions"><button class="btn btn-outline btn-sm" onclick="openCourseForm('${c.id}')">ìˆ˜ì •</button>
            <button class="btn btn-danger btn-sm" onclick="delItem('onlineCourses','${c.id}')">ì‚­ì œ</button></td></tr>`).join('')}</tbody></table>`;
      setupTableDragDrop('courseTbody', 'onlineCourses');
    }
    function openCourseForm(id) {
      const item = id ? D.onlineCourses.find(c => c.id === id) : null;
      openModal(`<h3>${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</h3>
        <div class="form-row"><label class="form-label">ì œëª© *</label><input class="form-input" id="f_title" value="${item?.title || ''}"/></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-row"><label class="form-label">í”Œë«í¼</label><input class="form-input" id="f_plat" value="${item?.platform || ''}"/></div>
          <div class="form-row"><label class="form-label">í•™ì </label><input class="form-input" id="f_credit" value="${item?.credit || ''}"/></div>
        </div>
        ${linkPreviewFormHTML(item)}
        <div class="form-actions"><button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-red" onclick="saveCourse('${id || ''}')">${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</button></div>`);
      refreshImageList();
      setupClipboardPaste();
    }
    function saveCourse(id) {
      let images = [];
      try { images = JSON.parse(document.getElementById('f_images_data').value || '[]'); } catch (e) { }
      const obj = {
        id: id || 'oc_' + uid(), title: document.getElementById('f_title').value.trim(),
        platform: document.getElementById('f_plat').value.trim(), credit: document.getElementById('f_credit').value.trim(),
        link: document.getElementById('f_view_link').value.trim(),
        previewDesc: document.getElementById('f_preview_desc').value.trim(),
        images, image: images[0] || ''
      };
      if (!obj.title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if (id) { const idx = D.onlineCourses.findIndex(c => c.id === id); D.onlineCourses[idx] = obj } else { D.onlineCourses.unshift(obj) }
      save(); closeModal(); render();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ìˆ˜ìƒ
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderAwards() {
      main.innerHTML = `<div class="page-header"><div class="page-title">ìˆ˜ìƒ <small>${D.awards.length}ê±´</small></div>
        <button class="btn btn-red" onclick="openAwardForm()">+ ì¶”ê°€</button></div>
        <table class="data-table"><thead><tr><th style="width:36px"></th><th></th><th>ì—°ë„</th><th>ì œëª©</th><th>ê¸°ê´€</th><th>ì£¼ìš”</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="awardTbody">${D.awards.map((a, i) => `<tr data-idx="${i}">
          <td><span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</span></td>
          <td>${a.images?.length ? `<img src="${a.images[0]}" class="td-thumb"/>` : ''}</td>
          <td>${a.year}</td><td>${a.title}</td><td style="color:var(--text2)">${a.org || '-'}</td>
          <td>${a.highlight ? '<span class="hl-badge">â˜…</span>' : ''}</td>
          <td class="actions"><button class="btn btn-outline btn-sm" onclick="openAwardForm('${a.id}')">ìˆ˜ì •</button>
          <button class="btn btn-danger btn-sm" onclick="delItem('awards','${a.id}')">ì‚­ì œ</button></td></tr>`).join('')}</tbody></table>`;
      setupTableDragDrop('awardTbody', 'awards');
    }
    function openAwardForm(id) {
      const item = id ? D.awards.find(a => a.id === id) : null;
      openModal(`<h3>${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</h3>
        <div class="form-row"><label class="form-label">ì œëª© *</label><input class="form-input" id="f_title" value="${item?.title || ''}"/></div>
        <div class="form-row"><label class="form-label">ê¸°ê´€</label><input class="form-input" id="f_org" value="${item?.org || ''}"/></div>
        <div class="form-row"><label class="form-label">ì—°ë„</label><input class="form-input" id="f_year" type="number" value="${item?.year || new Date().getFullYear()}"/></div>
        <div class="form-row"><label class="form-check"><input type="checkbox" id="f_hl" ${item?.highlight ? 'checked' : ''}/> ì£¼ìš” ìˆ˜ìƒ</label></div>
        ${linkPreviewFormHTML(item)}
        <div class="form-actions"><button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-red" onclick="saveAward('${id || ''}')">${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</button></div>`);
      refreshImageList();
      setupClipboardPaste();
    }
    function saveAward(id) {
      let images = [];
      try { images = JSON.parse(document.getElementById('f_images_data').value || '[]'); } catch (e) { }
      const obj = {
        id: id || 'a_' + uid(), title: document.getElementById('f_title').value.trim(),
        org: document.getElementById('f_org').value.trim(), year: +document.getElementById('f_year').value,
        highlight: document.getElementById('f_hl').checked,
        link: document.getElementById('f_view_link').value.trim(),
        previewDesc: document.getElementById('f_preview_desc').value.trim(),
        images, image: images[0] || ''
      };
      if (!obj.title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if (id) { const idx = D.awards.findIndex(a => a.id === id); D.awards[idx] = obj } else { D.awards.unshift(obj) }
      save(); closeModal(); render();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í™œë™
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderActivities() {
      main.innerHTML = `<div class="page-header"><div class="page-title">ì£¼ìš” í™œë™ <small>${D.activities.length}ê±´</small></div>
        <button class="btn btn-red" onclick="openActForm()">+ ì¶”ê°€</button></div>
        <table class="data-table"><thead><tr><th style="width:36px"></th><th></th><th>ê¸°ê°„</th><th>í™œë™ëª…</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="actTbody">${D.activities.map((a, i) => `<tr data-idx="${i}">
          <td><span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</span></td>
          <td>${a.images?.length ? `<img src="${a.images[0]}" class="td-thumb"/>` : ''}</td>
          <td>${a.period || '-'}</td><td>${a.title}</td>
          <td class="actions"><button class="btn btn-outline btn-sm" onclick="openActForm('${a.id}')">ìˆ˜ì •</button>
          <button class="btn btn-danger btn-sm" onclick="delItem('activities','${a.id}')">ì‚­ì œ</button></td></tr>`).join('')}</tbody></table>`;
      setupTableDragDrop('actTbody', 'activities');
    }
    function openActForm(id) {
      const item = id ? D.activities.find(a => a.id === id) : null;
      openModal(`<h3>${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</h3>
        <div class="form-row"><label class="form-label">í™œë™ëª… *</label><input class="form-input" id="f_title" value="${item?.title || ''}"/></div>
        <div class="form-row"><label class="form-label">ê¸°ê°„</label><input class="form-input" id="f_period" value="${item?.period || ''}" placeholder="ì˜ˆ: 2022~2024"/></div>
        ${linkPreviewFormHTML(item)}
        <div class="form-actions"><button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-red" onclick="saveAct('${id || ''}')">${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</button></div>`);
      refreshImageList();
      setupClipboardPaste();
    }
    function saveAct(id) {
      let images = [];
      try { images = JSON.parse(document.getElementById('f_images_data').value || '[]'); } catch (e) { }
      const obj = {
        id: id || 'act_' + uid(), title: document.getElementById('f_title').value.trim(),
        period: document.getElementById('f_period').value.trim(),
        link: document.getElementById('f_view_link').value.trim(),
        previewDesc: document.getElementById('f_preview_desc').value.trim(),
        images, image: images[0] || ''
      };
      if (!obj.title) return alert('í™œë™ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if (id) { const idx = D.activities.findIndex(a => a.id === id); D.activities[idx] = obj } else { D.activities.unshift(obj) }
      save(); closeModal(); render();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ë³´ë„ìë£Œ
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderPress() {
      main.innerHTML = `
        <div class="page-header"><div class="page-title">ë³´ë„ìë£Œ <small>${D.press.length}ê±´</small></div>
          <button class="btn btn-red" onclick="openPressForm()">+ ì¶”ê°€</button></div>
        <table class="data-table">
          <thead><tr><th style="width:36px"></th><th></th><th>ë‚ ì§œ</th><th>ì œëª©</th><th>ë§¤ì²´</th><th>ë¶€ê°€</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="pressTbody">${D.press.map((p, i) => `<tr data-idx="${i}">
            <td><span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â ¿</span></td>
            <td>${p.images?.length ? `<img src="${p.images[0]}" class="td-thumb" onerror="this.style.display='none'"/>` : ''}</td>
            <td>${p.date}</td><td>${p.title}</td><td style="color:var(--text2)">${p.source}</td>
            <td>${p.link ? '<span class="link-badge">ğŸ”—</span> ' : ''}${p.images?.length ? `<span class="img-badge">ğŸ–¼${p.images.length}</span>` : ''}</td>
            <td class="actions"><button class="btn btn-outline btn-sm" onclick="openPressForm('${p.id}')">ìˆ˜ì •</button>
            <button class="btn btn-danger btn-sm" onclick="delItem('press','${p.id}')">ì‚­ì œ</button></td></tr>`).join('')}</tbody></table>`;
      setupTableDragDrop('pressTbody', 'press');
    }

    function openPressForm(id) {
      const item = id ? D.press.find(p => p.id === id) : null;
      openModal(`
        <h3>${item ? 'ë³´ë„ìë£Œ ìˆ˜ì •' : 'ë³´ë„ìë£Œ ì¶”ê°€'}</h3>
        <div class="form-row"><label class="form-label">ì œëª© *</label><input class="form-input" id="f_title" value="${item?.title || ''}"/></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-row"><label class="form-label">ë§¤ì²´ëª…</label><input class="form-input" id="f_source" value="${item?.source || ''}"/></div>
          <div class="form-row"><label class="form-label">ë‚ ì§œ</label><input class="form-input" id="f_date" value="${item?.date || ''}" placeholder="2024.06.05"/></div>
        </div>
        ${linkPreviewFormHTML(item)}
        <div class="form-actions">
          <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
          <button class="btn btn-red" onclick="savePress('${id || ''}')">${item ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</button>
        </div>
      `);
      refreshImageList();
      setupClipboardPaste();
    }

    function savePress(id) {
      let images = [];
      try { images = JSON.parse(document.getElementById('f_images_data').value || '[]'); } catch (e) { }
      const obj = {
        id: id || 'p_' + uid(),
        title: document.getElementById('f_title').value.trim(),
        source: document.getElementById('f_source').value.trim(),
        date: document.getElementById('f_date').value.trim(),
        link: document.getElementById('f_view_link').value.trim(),
        previewDesc: document.getElementById('f_preview_desc').value.trim(),
        images
      };
      if (!obj.title) return alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      if (id) { const idx = D.press.findIndex(p => p.id === id); D.press[idx] = obj; }
      else { D.press.unshift(obj); }
      save(); closeModal(); render();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ê³µí†µ
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function delItem(key, id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      D[key] = D[key].filter(item => item.id !== id);
      save(); render();
    }

    function resetData() {
      if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.\n(ì´ë¯¸ì§€/ë§í¬ ë“± ëª¨ë“  í¸ì§‘ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤)\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      localStorage.removeItem('profileData');
      location.reload();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       í…Œì´ë¸” í–‰ ë“œë˜ê·¸ì•¤ë“œë¡­ (ìˆœìˆ˜ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ê¸°ë°˜)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function setupTableDragDrop(tbodyId, dataKey) {
      const tbody = document.getElementById(tbodyId);
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr[data-idx]'));
      rows.forEach(row => {
        const handle = row.querySelector('.drag-handle');
        if (!handle) return;

        handle.addEventListener('mousedown', e => {
          e.preventDefault();
          const fromIdx = +row.dataset.idx;
          let currentTargetRow = null;
          row.classList.add('dragging');
          row.style.opacity = '0.4';
          document.body.style.cursor = 'grabbing';
          document.body.style.userSelect = 'none';

          function onMouseMove(ev) {
            /* ëª¨ë“  í–‰ì˜ ì¸ë””ì¼€ì´í„° ì œê±° */
            rows.forEach(r => {
              r.style.borderTop = '';
              r.style.borderBottom = '';
            });
            /* í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ì•„ë˜ì˜ í–‰ ì°¾ê¸° */
            const allRows = Array.from(tbody.querySelectorAll('tr[data-idx]'));
            currentTargetRow = null;
            for (const r of allRows) {
              const rect = r.getBoundingClientRect();
              if (ev.clientY >= rect.top && ev.clientY <= rect.bottom) {
                if (r !== row) {
                  currentTargetRow = r;
                  const mid = rect.top + rect.height / 2;
                  if (ev.clientY < mid) {
                    r.style.borderTop = '3px solid var(--red)';
                  } else {
                    r.style.borderBottom = '3px solid var(--red)';
                  }
                }
                break;
              }
            }
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            row.classList.remove('dragging');
            row.style.opacity = '';
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            /* ëª¨ë“  ì¸ë””ì¼€ì´í„° ì œê±° */
            rows.forEach(r => {
              r.style.borderTop = '';
              r.style.borderBottom = '';
            });

            if (currentTargetRow) {
              const toIdx = +currentTargetRow.dataset.idx;
              if (fromIdx !== toIdx) {
                const arr = D[dataKey];
                const [moved] = arr.splice(fromIdx, 1);
                arr.splice(toIdx, 0, moved);
                render();
                showToast('âœ… ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
              }
            }
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ğŸ¤– AI ìë™ ë“±ë¡ (Gemini API & Google Drive)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function showToast(msg) { const t = document.createElement('div'); t.textContent = msg; Object.assign(t.style, { position: 'fixed', bottom: '24px', left: '50%', transform: 'translateX(-50%)', background: '#22c55e', color: '#fff', padding: '10px 24px', borderRadius: '8px', fontSize: '.85rem', fontWeight: '600', zIndex: '9999', boxShadow: '0 4px 16px rgba(0,0,0,.3)' }); document.body.appendChild(t); setTimeout(() => t.remove(), 2000); }
    function getApiKey() { return localStorage.getItem('gemini_api_key') || ''; }
    function setApiKey(k) { localStorage.setItem('gemini_api_key', k); }
    function getClientId() { return localStorage.getItem('google_client_id') || ''; }
    function setClientId(k) { localStorage.setItem('google_client_id', k); }

    /* Google Drive API ê´€ë ¨ ë³€ìˆ˜ */
    let tokenClient;
    let accessToken = null;
    let pickerInited = false;
    let gisInited = false;

    function gapiLoaded() { gapi.load('client:picker', async () => { await gapi.client.load('drive', 'v3'); pickerInited = true; }); }
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: getClientId(),
        scope: 'https://www.googleapis.com/auth/drive.readonly',
        callback: (resp) => {
          if (resp.error !== undefined) throw (resp);
          accessToken = resp.access_token;
          if (pendingPicker) createPicker();
        },
      });
      gisInited = true;
    }

    let pendingPicker = false;
    function handleAuthClick() {
      const clientId = getClientId();
      if (!clientId) return alert('Google Client IDë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');

      /* Client IDê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¬ì´ˆê¸°í™” ì‹œë„ */
      if (!tokenClient || tokenClient.client_id !== clientId) {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: 'https://www.googleapis.com/auth/drive.readonly',
          callback: (resp) => {
            if (resp.error !== undefined) throw (resp);
            accessToken = resp.access_token;
            if (pendingPicker) createPicker();
          },
        });
      }

      pendingPicker = true;
      if (accessToken === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } else {
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    function createPicker() {
      if (!pickerInited) return alert('Google API ë¡œë”© ì¤‘...');
      const view = new google.picker.View(google.picker.ViewId.DOCS);
      view.setMimeTypes('application/vnd.google-apps.document,application/vnd.google-apps.presentation,application/pdf,image/png,image/jpeg');
      const picker = new google.picker.PickerBuilder()
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
        .setAppId(getClientId())
        .setOAuthToken(accessToken)
        .addView(view)
        .setCallback(pickerCallback)
        .build();
      picker.setVisible(true);
      pendingPicker = false;
    }

    async function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const fileId = data.docs[0].id;
        const mimeType = data.docs[0].mimeType;
        const name = data.docs[0].name;

        const status = document.getElementById('fileStatus') || document.getElementById('previewResult');
        if (status) status.innerHTML = `<div class="ai-status"><span class="fetching">ğŸ”„ "${name}" ë‚´ìš© ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span></div>`;

        try {
          const content = await fetchDriveContent(fileId, mimeType);

          /* PDFì¸ ê²½ìš° í˜ì´ì§€ ì„ íƒê¸° í˜¸ì¶œ */
          if (mimeType.includes('pdf')) {
            openPageSelector(content);
            if (status) status.innerHTML = '';
            window.pendingAnalysisFile = name;
            return;
          }

          /* Auto Register íƒ­ì¸ì§€ ê°œë³„ í¼ì¸ì§€ í™•ì¸ */
          if (currentTab === 'autoRegister') {
            const prompt = `ë‹¤ìŒ ë¬¸ì„œì˜ ë‚´ìš©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.
íŒŒì¼ì´ë¦„: ${name}
ë‚´ìš©:
${content.substring(0, 30000)} ... (ìƒëµ)

ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”(JSONë§Œ, ì„¤ëª… ì—†ì´):
{"category":"lectures|awards|press|publications|activities","title":"ì œëª©","org":"ê¸°ê´€ëª…","year":2025,"date":"ë‚ ì§œ","description":"ì„¤ëª…","highlight":false}`;

            status.innerHTML = `<div class="ai-status"><span class="fetching">ğŸ¤– "${name}" ë¶„ì„ ì¤‘...</span></div>`;
            const result = await callGeminiText(prompt);
            /* ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì¶”ê°€ ì²˜ë¦¬ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„  í…ìŠ¤íŠ¸ ìœ„ì£¼ */
            showAiResult(result, [`https://lh3.googleusercontent.com/d/${fileId}=w400`]); // ì¸ë„¤ì¼ì€ ê³µê°œ ì—¬ë¶€ì— ë”°ë¼ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìŒ
          } else {
            /* ê°œë³„ í¼ ìë™ ì…ë ¥ */
            status.innerHTML = `<div class="ai-status"><span class="fetching">ğŸ¤– "${name}" ë¶„ì„ ì¤‘...</span></div>`;
            const prompt = `ë‹¤ìŒ ë¬¸ì„œì˜ ë‚´ìš©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.
íŒŒì¼ì´ë¦„: ${name}
ë‚´ìš©:
${content.substring(0, 30000)}

ì´ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì•„ë˜ JSONìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{"title":"ì œëª©","org":"ê¸°ê´€/ì¶œíŒì‚¬/ì£¼ìµœ","year":2025,"description":"ê°„ë‹¨í•œ ì„¤ëª…","tags":["íƒœê·¸1","íƒœê·¸2"],"source":"ì¶œì²˜/ë§¤ì²´ëª…","date":"ë‚ ì§œ"}`;
            const aiResult = await callGeminiText(prompt);
            autoFillFormFields(aiResult, { title: name, description: aiResult.description });

            /* ì¸ë„¤ì¼ ì¶”ê°€ ì‹œë„ (ê¶Œí•œ ë¬¸ì œë¡œ ë³´ì¼ì§€ ëª¨ë¥´ì§€ë§Œ ë§í¬ë¼ë„ ì €ì¥) */
            const imgInput = document.getElementById('f_images_data');
            if (imgInput) {
              let imgs = [];
              try { imgs = JSON.parse(imgInput.value || '[]'); } catch (e) { }
              imgs.push(`https://lh3.googleusercontent.com/d/${fileId}=w1000`);
              imgInput.value = JSON.stringify(imgs);
              refreshImageList();
            }

            if (status) status.innerHTML = `<div style="font-size:.82rem;color:var(--green);margin-bottom:8px">âœ… êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ë¶„ì„ ì™„ë£Œ!</div>`;
          }
        } catch (err) {
          if (status) status.innerHTML = `<div class="ai-status" style="color:#ef4444">âŒ ì˜¤ë¥˜: ${err.message}</div>`;
        }
      }
    }

    async function fetchDriveContent(fileId, mimeType) {
      if (!gapi.client.drive) await gapi.client.load('drive', 'v3');

      let res;
      if (mimeType.includes('google-apps.document') || mimeType.includes('google-apps.presentation')) {
        /* êµ¬ê¸€ ë¬¸ì„œëŠ” í…ìŠ¤íŠ¸ë¡œ ë‚´ë³´ë‚´ê¸° */
        res = await gapi.client.drive.files.export({ fileId: fileId, mimeType: 'text/plain' });
        return res.body;
      } else if (mimeType.includes('pdf') || mimeType.includes('image')) {
        /* PDFë‚˜ ì´ë¯¸ì§€ëŠ” Vision API ì‚¬ìš©ì„ ìœ„í•´ Base64ë¡œ ë°›ì•„ì•¼ í•¨ - ì¼ë‹¨ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë¶ˆê°€ ì‹œ ë©”íƒ€ë°ì´í„°ë§Œ? 
           PDF ë‚´ìš©ì„ ì½ìœ¼ë ¤ë©´ drive.files.get alt=mediaë¡œ ë°›ì•„ì„œ pdf.js í•„ìš”... 
           ì—¬ê¸°ì„  ê°„ë‹¨íˆ ì´ë¯¸ì§€ëŠ” base64 get, PDFëŠ” íŒŒì¼ëª…/ë©”íƒ€ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ íƒ€í˜‘í•˜ê±°ë‚˜
           Gemini Visionì´ PDFë„ ì§€ì›í•˜ë¯€ë¡œ PDFë„ base64ë¡œ ë°›ì•„ì„œ Visionì— ë˜ì§ˆ ìˆ˜ ìˆìŒ.
        */
        /* PDF Download logic needs token */
        const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
          headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        // For now, simpler approach: return just file name/metadata if binary
        // Actually Gemini Vision can handle PDF base64. Let's try to get blob -> base64
        const blob = await resp.blob();
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result); // Data URL
          reader.readAsDataURL(blob);
        });
      }
      return '';
    }


    function renderAutoRegister() {
      const key = getApiKey();
      const clientId = getClientId();
      main.innerHTML = `
        <div class="page-header"><div class="page-title">ğŸ¤– AI ìë™ ë“±ë¡</div></div>
        <div class="api-key-area">
          <label class="form-label">API ì„¤ì •</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label class="form-label" style="font-size:.75rem">Gemini API í‚¤</label>
              <div class="link-row">
                <input class="form-input" id="apiKeyInput" type="password" value="${key}" placeholder="AIza..."/>
                <button class="btn btn-green btn-sm" onclick="setApiKey(document.getElementById('apiKeyInput').value.trim());showToast('ì €ì¥ë¨')">ì €ì¥</button>
              </div>
            </div>
            <div>
              <label class="form-label" style="font-size:.75rem">Google Client ID (ë“œë¼ì´ë¸Œ ì—°ë™ìš©)</label>
              <div class="link-row">
                <input class="form-input" id="clientIdInput" value="${clientId}" placeholder="...apps.googleusercontent.com"/>
                <button class="btn btn-blue btn-sm" onclick="setClientId(document.getElementById('clientIdInput').value.trim());showToast('ì €ì¥ë¨')">ì €ì¥</button>
              </div>
            </div>
          </div>
          <div class="form-hint">Google Cloud Consoleì—ì„œ <strong>OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID</strong>ë¥¼ ìƒì„±í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”. (ìŠ¹ì¸ëœ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì›ë³¸ì— í˜„ì¬ ë„ë©”ì¸ ì¶”ê°€ í•„ìˆ˜)</div>
        </div>
        <div class="auto-zone">
          <h4>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ (ìƒì¥, ê³µë¬¸, ê°•ì˜ìë£Œ ì´ë¯¸ì§€ ë“±)</h4>
          <div style="display:flex;gap:12px;margin-bottom:12px">
            <button class="btn btn-outline" style="flex:1;padding:20px" onclick="document.getElementById('fileInput').click()">
              <span style="font-size:1.5rem">ğŸ“‚</span><br/>ë‚´ PCì—ì„œ ì„ íƒ
            </button>
            <button class="btn btn-outline" style="flex:1;padding:20px" onclick="handleAuthClick()">
              <span style="font-size:1.5rem">â˜ï¸</span><br/>Google Driveì—ì„œ ì„ íƒ
            </button>
          </div>
          <input type="file" id="fileInput" accept="image/*,.pdf" multiple style="display:none"/>
          <div id="fileStatus"></div>
        </div>
        <div class="auto-zone">
          <h4>ğŸ”— URL ì…ë ¥ (ìœ íŠœë¸Œ ê°•ì˜, ë‰´ìŠ¤ ê¸°ì‚¬ ë“±)</h4>
          <div class="link-row">
            <input class="form-input" id="autoUrl" placeholder="https://... (ìœ íŠœë¸Œ, ë‰´ìŠ¤ ê¸°ì‚¬, êµì•ˆ ë§í¬ ë“±)"/>
            <button class="btn btn-red" onclick="analyzeUrl()">AI ë¶„ì„</button>
          </div>
          <div id="urlStatus"></div>
        </div>
        <div id="aiResults"></div>
      `;
      setupDropArea();
    }

    function setupDropArea() {
      const drop = document.getElementById('dropArea');
      const input = document.getElementById('fileInput');
      if (!drop) return;
      drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
      drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
      drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
      input.addEventListener('change', e => handleFiles(e.target.files));
    }

    async function handleFiles(files) {
      if (!getApiKey()) return alert('Gemini API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
      const status = document.getElementById('fileStatus');
      for (const file of files) {
        status.innerHTML = `<div class="ai-status"><span class="fetching">ğŸ”„ "${file.name}" ë¶„ì„ ì¤‘... (Gemini AI)</span></div>`;
        try {
          const base64 = await fileToBase64(file);
          const mime = file.type || 'image/jpeg';
          const result = await callGeminiVision(base64, mime);
          showAiResult(result, [base64ToDataUrl(base64, mime)]);
        } catch (err) {
          status.innerHTML = `<div class="ai-status" style="color:#ef4444">âŒ ë¶„ì„ ì‹¤íŒ¨: ${err.message}</div>`;
        }
      }
    }

    async function analyzeUrl() {
      const url = document.getElementById('autoUrl')?.value?.trim();
      if (!url) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      if (!getApiKey()) return alert('Gemini API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
      const status = document.getElementById('urlStatus');
      status.innerHTML = `<div class="ai-status"><span class="fetching">ğŸ”„ URL ë¶„ì„ ì¤‘...</span></div>`;
      try {
        let preview = null;
        try { preview = await fetchLinkPreview(url); } catch (e) { }
        const prompt = `ë‹¤ìŒ URLì˜ ë‚´ìš©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.
URL: ${url}
${preview ? `ì œëª©: ${preview.title}\nì„¤ëª…: ${preview.description}` : ''}

ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”(JSONë§Œ, ì„¤ëª… ì—†ì´):
{"category":"lectures|awards|press|publications|activities","title":"ì œëª©","org":"ê¸°ê´€ëª…","year":2025,"date":"ë‚ ì§œ","description":"ì„¤ëª…","highlight":false}`;
        const result = await callGeminiText(prompt);
        result.link = url;
        result.images = preview?.images || [];
        const ytId = getYouTubeId(url);
        if (ytId && !result.images.length) result.images = [`https://img.youtube.com/vi/${ytId}/maxresdefault.jpg`];
        showAiResult(result, result.images);
      } catch (err) {
        status.innerHTML = `<div class="ai-status" style="color:#ef4444">âŒ ${err.message}</div>`;
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    function base64ToDataUrl(b64, mime) { return `data:${mime};base64,${b64}`; }

    async function callGeminiVision(base64, mime) {
      const key = getApiKey();
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { inlineData: { mimeType: mime, data: base64 } },
              {
                text: `ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”. ìƒì¥, ê³µë¬¸(ê°•ì˜ ì˜ë¢°ì„œ), ê°•ì˜ ìŠ¬ë¼ì´ë“œ, ë‰´ìŠ¤ ê¸°ì‚¬ ìŠ¤í¬ë¦°ìƒ· ë“±ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ë¯¸ì§€ ë‚´ìš©ì„ íŒŒì•…í•˜ì—¬ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”(JSONë§Œ, ì„¤ëª… ì—†ì´):
{"category":"lectures|awards|press|publications|activities","title":"ì œëª© ë˜ëŠ” ìƒì¥ëª…","org":"ìˆ˜ì—¬ê¸°ê´€/ì£¼ìµœê¸°ê´€","year":2025,"date":"ë‚ ì§œ(ìˆìœ¼ë©´)","description":"ì£¼ìš” ë‚´ìš© ìš”ì•½","highlight":false,"source":"ë§¤ì²´ëª…(ë³´ë„ìë£Œì¸ ê²½ìš°)"}

category íŒë‹¨ ê¸°ì¤€:
- ìƒì¥/í‘œì°½ì¥/ê°ì‚¬ì¥ â†’ awards
- ê°•ì˜ ì˜ë¢° ê³µë¬¸/ê°•ì—° ê´€ë ¨ â†’ lectures
- ì‹ ë¬¸ê¸°ì‚¬/ë³´ë„ìë£Œ â†’ press
- ì±… í‘œì§€/ì¶œíŒ ê´€ë ¨ â†’ publications
- ê¸°íƒ€ í™œë™ â†’ activities` }
            ]
          }]
        })
      });
      const json = await res.json();
      if (json.error) throw new Error(json.error.message);
      const text = json.candidates?.[0]?.content?.parts?.[0]?.text || '';
      return parseGeminiJson(text);
    }

    async function callGeminiText(prompt) {
      const key = getApiKey();
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const json = await res.json();
      if (json.error) throw new Error(json.error.message);
      const text = json.candidates?.[0]?.content?.parts?.[0]?.text || '';
      return parseGeminiJson(text);
    }

    function parseGeminiJson(text) {
      const m = text.match(/\{[\s\S]*\}/);
      if (!m) throw new Error('AI ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return JSON.parse(m[0]);
    }

    function showAiResult(result, previewImages) {
      const area = document.getElementById('aiResults');
      const catLabels = { lectures: 'ğŸ¤ ê°•ì˜', awards: 'ğŸ† ìˆ˜ìƒ', press: 'ğŸ“° ë³´ë„ìë£Œ', publications: 'ğŸ“š ì €ì„œ', activities: 'ğŸ“Œ í™œë™' };
      area.innerHTML = `
        <div class="ai-result-card">
          <h4>âœ… AI ë¶„ì„ ê²°ê³¼</h4>
          <div class="ai-field"><span class="label">ì¹´í…Œê³ ë¦¬</span><span class="value">${catLabels[result.category] || result.category}</span></div>
          <div class="ai-field"><span class="label">ì œëª©</span><span class="value">${result.title || '-'}</span></div>
          <div class="ai-field"><span class="label">ê¸°ê´€</span><span class="value">${result.org || result.source || '-'}</span></div>
          <div class="ai-field"><span class="label">ì—°ë„</span><span class="value">${result.year || '-'}</span></div>
          ${result.date ? `<div class="ai-field"><span class="label">ë‚ ì§œ</span><span class="value">${result.date}</span></div>` : ''}
          ${result.description ? `<div class="ai-field"><span class="label">ì„¤ëª…</span><span class="value">${result.description}</span></div>` : ''}
          ${previewImages?.length ? `<div class="ai-img-preview">${previewImages.map(i => `<img src="${i}" onerror="this.remove()"/>`).join('')}</div>` : ''}
          <div style="display:flex;gap:8px;margin-top:16px">
            <button class="btn btn-red" onclick='confirmAutoRegister(${JSON.stringify(result).replace(/'/g, "\\'")},[${(previewImages || []).map(i => '"' + i.replace(/"/g, '') + '"').join(',')}])'>ì´ëŒ€ë¡œ ë“±ë¡</button>
            <button class="btn btn-outline" onclick="document.getElementById('aiResults').innerHTML=''">ì·¨ì†Œ</button>
          </div>
        </div>
      `;
    }

    function confirmAutoRegister(result, images) {
      const id = uid();
      const cat = result.category;
      if (cat === 'lectures') {
        D.lectures.unshift({ id: 'l_' + id, title: result.title || '', org: result.org || '', year: result.year || new Date().getFullYear(), category: result.lecCategory || 'ê¸°ì¡°ê°•ì—°/ë°œí‘œ', highlight: !!result.highlight, link: result.link || '', previewDesc: result.description || '', images: images || [], image: images?.[0] || '' });
      } else if (cat === 'awards') {
        D.awards.unshift({ id: 'a_' + id, title: result.title || '', org: result.org || '', year: result.year || new Date().getFullYear(), highlight: !!result.highlight });
      } else if (cat === 'press') {
        D.press.unshift({ id: 'p_' + id, title: result.title || '', source: result.source || result.org || '', date: result.date || '', link: result.link || '', previewDesc: result.description || '', images: images || [] });
      } else if (cat === 'publications') {
        D.publications.unshift({ id: 'pub_' + id, title: result.title || '', publisher: result.org || '', year: result.year || new Date().getFullYear(), description: result.description || '', tags: [], images: images || [], image: images?.[0] || '', link: result.link || '' });
      } else if (cat === 'activities') {
        D.activities.unshift({ id: 'act_' + id, title: result.title || '', period: result.date || '' });
      }
      save();
      document.getElementById('aiResults').innerHTML = `<div class="ai-status" style="color:var(--green)">âœ… <strong>${result.title}</strong>ì´(ê°€) <strong>${cat}</strong>ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>`;
    }

    function render() {
      switch (currentTab) {
        case 'dashboard': renderDashboard(); break;
        case 'autoRegister': renderAutoRegister(); break;
        case 'lectures': renderLectures(); break;
        case 'publications': renderPublications(); break;
        case 'courses': renderCourses(); break;
        case 'awards': renderAwards(); break;
        case 'activities': renderActivities(); break;
        case 'press': renderPress(); break;
      }
    }
    render();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

  <!-- PDF í˜ì´ì§€ ì„ íƒ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="pageSelectorModal" style="z-index:9999">
    <div class="modal"
      style="width:1000px;max-width:95vw;height:90vh;display:flex;flex-direction:column;padding:0;background:var(--bg)">
      <div
        style="padding:16px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--card)">
        <h3 style="margin:0;font-size:1.1rem">ğŸ“„ í•µì‹¬ í˜ì´ì§€ ì„ íƒ</h3>
        <button class="btn btn-outline btn-sm" onclick="closePageSelector()">ë‹«ê¸°</button>
      </div>
      <div id="pdfPageGrid"
        style="flex:1;overflow-y:auto;padding:24px;display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:20px;align-content:start;">
        <!-- ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ -->
      </div>
      <div
        style="padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px;background:var(--card);align-items:center">
        <div style="margin-right:auto;display:flex;align-items:center;gap:8px">
          <span id="selectedCount" style="font-weight:700;color:var(--blue)">0ì¥ ì„ íƒë¨</span>
          <span style="font-size:.85rem;color:var(--text2)">(í´ë¦­í•˜ì—¬ ì„ íƒ/í•´ì œ)</span>
        </div>
        <button class="btn btn-outline" onclick="closePageSelector()">ì·¨ì†Œ</button>
        <button class="btn btn-blue" onclick="confirmPageSelection()">ì„ íƒ ì™„ë£Œ</button>
      </div>
    </div>
  </div>
  <style>
    .pdf-page-item {
      position: relative;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 8px;
      overflow: hidden;
      transition: all .2s;
      background: #000;
    }

    .pdf-page-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .5);
    }

    .pdf-page-item.selected {
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, .5);
    }

    .pdf-page-item img {
      width: 100%;
      height: auto;
      display: block;
      opacity: .85;
      transition: opacity .2s
    }

    .pdf-page-item.selected img {
      opacity: 1
    }

    .pdf-page-num {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(0, 0, 0, .7);
      color: #fff;
      font-size: .75rem;
      padding: 2px 6px;
      border-radius: 4px;
      pointer-events: none;
    }

    .pdf-check {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, .6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: transparent;
      border: 2px solid rgba(255, 255, 255, .5);
      transition: all .2s;
      pointer-events: none;
    }

    .pdf-page-item.selected .pdf-check {
      background: var(--blue);
      border-color: var(--blue);
      color: #fff;
    }
  </style>
  <script>
    let currentPdfDoc = null;
    let selectedPdfPages = new Set();
    let currentPdfImages = []; /* ë Œë”ë§ëœ ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥ */

    async function openPageSelector(data) {
      const modal = document.getElementById('pageSelectorModal');
      const grid = document.getElementById('pdfPageGrid');
      const counter = document.getElementById('selectedCount');

      modal.classList.add('open');
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px"><span class="fetching">PDF ë¡œë”© ì¤‘...</span></div>';
      selectedPdfPages.clear();
      currentPdfImages = [];
      counter.textContent = '0ì¥ ì„ íƒë¨';

      try {
        const loadingTask = pdfjsLib.getDocument(data);
        currentPdfDoc = await loadingTask.promise;

        grid.innerHTML = '';
        for (let i = 1; i <= currentPdfDoc.numPages; i++) {
          renderPdfPageThumbnail(i, grid);
        }
      } catch (err) {
        grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--red)">PDF ë¡œë“œ ì‹¤íŒ¨: ${err.message}</div>`;
      }
    }

    async function renderPdfPageThumbnail(num, container) {
      const page = await currentPdfDoc.getPage(num);
      const scale = 0.5; /* ì¸ë„¤ì¼ìš© ìŠ¤ì¼€ì¼ */
      const viewport = page.getViewport({ scale });

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({ canvasContext: context, viewport: viewport }).promise;

      const imgData = canvas.toDataURL('image/jpeg', 0.8);
      currentPdfImages[num] = imgData;

      const div = document.createElement('div');
      div.className = 'pdf-page-item';
      div.onclick = () => togglePdfPage(num, div);
      div.innerHTML = `
        <img src="${imgData}"/>
        <div class="pdf-check">âœ”</div>
        <div class="pdf-page-num">${num}</div>
      `;
      container.appendChild(div);
    }

    function togglePdfPage(num, el) {
      if (selectedPdfPages.has(num)) {
        selectedPdfPages.delete(num);
        el.classList.remove('selected');
      } else {
        selectedPdfPages.add(num);
        el.classList.add('selected');
      }
      document.getElementById('selectedCount').textContent = `${selectedPdfPages.size}ì¥ ì„ íƒë¨`;
    }

    function closePageSelector() {
      document.getElementById('pageSelectorModal').classList.remove('open');
      currentPdfDoc = null;
    }

    function confirmPageSelection() {
      if (selectedPdfPages.size === 0) return alert('ìµœì†Œ 1ì¥ì˜ í˜ì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');

      /* ì„ íƒëœ í˜ì´ì§€ë¥¼ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ */
      const sortedPages = Array.from(selectedPdfPages).sort((a, b) => a - b);
      const newImages = sortedPages.map(p => currentPdfImages[p]);

      /* í˜„ì¬ ì—´ë ¤ìˆëŠ” í¼ì´ ìˆëŠ”ì§€ í™•ì¸ (Auto Register vs Individual Form) */
      if (currentTab === 'autoRegister') {
        /* Auto Registerì—ì„œëŠ” 'showAiResult' í˜¸ì¶œ ì‹œ ì´ë¯¸ì§€ë¥¼ ì „ë‹¬í•´ì•¼ í•¨ */
        /* í•˜ì§€ë§Œ analyzeUrl ë“±ì´ í˜¸ì¶œëœ ìƒíƒœê°€ ì•„ë‹ˆë¯€ë¡œ, ì „ì—­ ë³€ìˆ˜ë‚˜ ì½œë°± í•„ìš” */
        /* ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ 'aiResults' ì˜ì—­ì— ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë„ìš°ê³ , ì¶”í›„ AI ë¶„ì„ ì‹œ ì‚¬ìš©ë˜ë„ë¡... */
        /* ë³µì¡: Auto Register ë¡œì§ì´ Analyze -> Show Result ìˆœì„œì„. */
        /* ë”°ë¼ì„œ, Auto Registerì—ì„œëŠ” 'File Upload' -> 'Page Selector' -> 'Gemini Calc' ìˆœì„œë¡œ ê°€ì•¼ í•¨. */
        /* handleFormFileUploadë‚˜ pickerCallbackì—ì„œ ì´ íë¦„ì„ ì œì–´í•´ì•¼ í•¨. */

        /* ì¼ë‹¨ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš© */
        window.lastSelectedImages = newImages;
        /* Analyze Trigger */
        if (window.pendingAnalysisFile) {
          analyzePdfTextWithImages(window.pendingAnalysisFile, newImages);
        }
      } else {
        /* ê°œë³„ í¼ (Edit Mode) */
        const imgInput = document.getElementById('f_images_data');
        if (imgInput) {
          let imgs = [];
          try { imgs = JSON.parse(imgInput.value || '[]'); } catch (e) { }
          /* ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€? ì•„ë‹ˆë©´ êµì²´? ì‚¬ìš©ì ì„ íƒ ì¡´ì¤‘í•˜ì—¬ ì¶”ê°€ */
          newImages.forEach(img => imgs.push(img));
          imgInput.value = JSON.stringify(imgs);
          refreshImageList();
          showToast(`í˜ì´ì§€ ${newImages.length}ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
      }
      closePageSelector();
    }
  </script>
</body>

</html>